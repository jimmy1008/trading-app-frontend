<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>交易控制儀表板</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="./assets/css/records.css" />
</head>
<body class="bg-white text-black">
  <aside class="w-64 px-6 py-8 flex flex-col border-r border-gray-200 fixed inset-y-0 bg-white z-20">
    <div class="flex-1">
      <div class="w-28 h-28 border border-gray-300 rounded-full mx-auto mb-2 overflow-hidden cursor-pointer" id="avatar-box">
        <img id="user-avatar" src="" alt="使用者頭像" class="w-full h-full object-cover" />
        <input id="avatar-input" type="file" accept="image/*" class="hidden" />
      </div>
      <div id="user-name" class="text-center font-semibold tracking-wide">user</div>
      <div id="user-uid" class="text-center text-xs text-gray-500 mb-6">UID : 100001</div>
      <div class="border border-gray-300 rounded-2xl px-4 py-3 mb-6">
        <div id="exchange-list" class="space-y-1"></div>
        <button id="add-exchange-btn" class="mt-3 w-full border border-gray-300 rounded-xl text-sm py-1 hover:bg-gray-100 transition" aria-haspopup="dialog" aria-controls="exchange-picker-bg">
          +
        </button>
      </div>
    </div>
    <div>
      <button id="quick-add-btn" class="w-full border border-gray-300 rounded-xl py-2 text-sm hover:bg-gray-100 transition">
        快速建立
      </button>
    </div>
  </aside>

  <main class="main-air ml-64 p-10">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 bg-white/80 border border-gray-200 rounded-2xl px-6 py-3 shadow-sm">
      <div>
        <div class="text-xs text-gray-500">目前登入帳號</div>
        <div id="nav-email" class="text-sm font-semibold">--</div>
      </div>
      <div class="flex items-center gap-3">
        <a id="nav-profile" href="profile.html" class="px-4 py-2 border border-gray-300 rounded-xl text-sm hover:bg-gray-100 transition">個人資料</a>
        <button id="nav-logout" class="px-4 py-2 bg-black text-white rounded-xl text-sm hover:bg-gray-800 transition">
          登出
        </button>
      </div>
    </div>
    <section class="page-heading">
      <div class="heading-tabs">
        <a class="heading-link active" href="index.html">儀表板</a>
        <span class="heading-divider">/</span>
        <a class="heading-link" href="portfolio.html">資產</a>
      </div>
    </section>

    <section class="hero-section">
      <div class="hero-card hero-grid">
        <div class="hero-main">
          <div class="hero-label">總資產</div>
          <div id="total-usdt" class="hero-amount">0 USDT</div>
          <div id="total-twd" class="hero-subtext">≈ 0 TWD</div>
          <div class="hero-meta-label mt-4">今日盈虧</div>
          <div id="today-pnl" class="hero-meta-value">+0 USDT</div>
        </div>
        <div class="hero-trend">
          <div class="hero-trend-title">24h Mini Trend</div>
          <svg id="today-sparkline" viewBox="0 0 120 40" preserveAspectRatio="none">
            <polyline id="today-sparkline-line" points="" />
          </svg>
        </div>
        <div class="hero-activity">
          <div class="hero-activity-block">
            <div class="hero-activity-label">今日已紀錄</div>
            <div id="today-count" class="hero-activity-value">0 筆</div>
          </div>
          <div class="hero-activity-block">
            <div class="hero-activity-label">今日勝率</div>
            <div id="today-winrate" class="hero-activity-value">0%</div>
          </div>
        </div>
      </div>
    </section>

    <section class="recent-activity-section">
      <div class="recent-grid">
        <div>
          <div class="section-header">
            <h2 class="section-title">最近一次交易</h2>
          </div>
          <div id="spotlight-card" class="spotlight-card glass-panel empty">
            <div class="spotlight-empty">暫無紀錄</div>
          </div>
        </div>
        <div>
          <div class="section-header">
            <h2 class="section-title">近 7 日活動</h2>
          </div>
          <div class="timeline-card glass-panel compact">
            <div id="activity-dots" class="timeline-dots"></div>
            <div id="activity-details" class="timeline-details hidden"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="behavior-section">
      <div class="section-header">
        <h2 class="section-title">交易類型分析</h2>
      </div>
      <div class="behavior-grid">
        <div class="behavior-card glass-panel">
          <div class="behavior-icon">📈</div>
          <div>
            <div class="behavior-label">多單比例</div>
            <div id="behavior-long" class="behavior-value">0%</div>
          </div>
        </div>
        <div class="behavior-card glass-panel">
          <div class="behavior-icon">📉</div>
          <div>
            <div class="behavior-label">空單比例</div>
            <div id="behavior-short" class="behavior-value">0%</div>
          </div>
        </div>
        <div class="behavior-card glass-panel">
          <div class="behavior-icon">⚙️</div>
          <div>
            <div class="behavior-label">平均槓桿</div>
            <div id="behavior-leverage" class="behavior-value">0x</div>
          </div>
        </div>
        <div class="behavior-card glass-panel">
          <div class="behavior-icon">⭐</div>
          <div>
            <div class="behavior-label">最常交易</div>
            <div id="behavior-favorite" class="behavior-value">-</div>
          </div>
        </div>
      </div>
    </section>

    <section class="results-section">
      <div class="results-grid">
        <div class="result-card glass-panel">
          <div class="result-card-title">📈 最近 3 筆最佳交易</div>
          <div id="best-trades" class="result-list"></div>
        </div>
        <div class="result-card glass-panel">
          <div class="result-card-title">📉 最近 3 筆最差交易</div>
          <div id="worst-trades" class="result-list"></div>
        </div>
      </div>
    </section>

    <section class="records-section records-list-section">
      <div class="section-header">
        <h2 class="section-title">紀錄</h2>
      </div>
      <div id="records-container" class="records-grid"></div>
    </section>
  </main>

  <!-- Exchange Picker -->
  <div id="exchange-picker-bg" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-center justify-center z-40" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="bg-white w-full max-w-4xl rounded-2xl border border-gray-200 p-8 shadow-2xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">選擇交易所</h2>
        <button id="exchange-picker-close" class="text-gray-500 hover:text-gray-800 text-2xl" aria-label="關閉交易所視窗">×</button>
      </div>
      <div class="grid grid-cols-3 md:grid-cols-4 gap-6">
        <button class="exchange-card" data-ex="binance" aria-label="選擇 Binance">
          <img src="./assets/img/binance.png" alt="Binance" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">Binance</p>
        </button>
        <button class="exchange-card" data-ex="bybit" aria-label="選擇 Bybit">
          <img src="./assets/img/bybit.png" alt="Bybit" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">Bybit</p>
        </button>
        <button class="exchange-card" data-ex="bitget" aria-label="選擇 Bitget">
          <img src="./assets/img/bitget.png" alt="Bitget" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">Bitget</p>
        </button>
        <button class="exchange-card" data-ex="okx" aria-label="選擇 OKX">
          <img src="./assets/img/okx.png" alt="OKX" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">OKX</p>
        </button>
        <button class="exchange-card" data-ex="bingx" aria-label="選擇 BingX">
          <img src="./assets/img/bingx.png" alt="BingX" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">BingX</p>
        </button>
        <button class="exchange-card" data-ex="mexc" aria-label="選擇 MEXC">
          <img src="./assets/img/mexc.png" alt="MEXC" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">MEXC</p>
        </button>
        <button class="exchange-card" data-ex="gate" aria-label="選擇 Gate.io">
          <img src="./assets/img/gate.png" alt="Gate.io" class="exchange-picker-logo mx-auto mb-2" />
          <p class="text-center text-lg font-medium">Gate.io</p>
        </button>
      </div>
    </div>
  </div>

  <!-- API Modal -->
  <div id="api-modal-bg" class="fixed inset-0 bg-black/30 hidden flex items-center justify-center z-50" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="bg-white w-80 rounded-2xl border border-gray-200 p-6 shadow-xl space-y-4">
      <h2 id="api-modal-title" class="text-lg font-semibold">連接交易所</h2>
      <div>
        <label class="block text-sm mb-1 text-gray-700">API Key</label>
        <input id="exchange-key" type="text" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm bg-white" />
      </div>
      <div>
        <label class="block text-sm mb-1 text-gray-700">API Secret</label>
        <input id="exchange-secret" type="password" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm bg-white" />
      </div>
      <div>
        <label class="block text-sm mb-1 text-gray-700">Passphrase（Bitget / OKX）</label>
        <input id="exchange-passphrase" type="password" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm bg-white" />
      </div>
      <div class="flex justify-end gap-3 pt-2">
        <button id="api-cancel" class="border border-gray-300 rounded-xl px-4 py-2 text-sm hover:bg-gray-100">取消</button>
        <button id="api-save" class="px-5 py-2 bg-black text-white rounded-xl text-sm hover:bg-gray-800 transition">保存</button>
      </div>
    </div>
  </div>

  <!-- Record Modal -->
  <div id="record-modal-bg" class="fixed inset-0 bg-black/30 hidden z-[80] flex items-center justify-center">
    <div id="record-modal" class="w-full bg-white border border-gray-200 rounded-[32px] shadow-2xl p-8 space-y-8" style="max-width:1080px;">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold">快速建立交易紀錄</h2>
        <button id="record-close" class="text-2xl text-gray-500 hover:text-gray-800" aria-label="關閉">×</button>
      </div>
      <div class="record-modal-body grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="record-left-stack space-y-6">
          <div id="record-image-area" class="record-image-drop">
            <img id="record-image-preview" class="hidden max-h-full object-cover" alt="紀錄預覽圖" />
            <div class="record-image-placeholder">
              <span class="text-lg">＋</span>
              <span>點擊或拖曳加入圖片（可選）</span>
            </div>
            <input id="record-image-input" type="file" accept="image/*" class="hidden" />
          </div>
          <div class="record-section">
            <div class="record-section-title">交易資訊</div>
            <div class="form-grid">
              <div>
                <label class="block text-sm mb-1 text-gray-600">幣種</label>
                <input id="record-symbol" class="record-input-control" placeholder="例如：BTC / ETH / SOL">
              </div>
              <div>
                <label class="block text-sm mb-1 text-gray-600">時間</label>
                <input id="record-date" type="date" class="record-input-control bg-white">
              </div>
              <div>
                <label class="block text-sm mb-1 text-gray-600">方向</label>
                <select id="record-side" class="record-input-control bg-white">
                  <option value="">請選擇</option>
                  <option value="long">做多</option>
                  <option value="short">做空</option>
                </select>
              </div>
              <div>
                <label class="block text-sm mb-1 text-gray-600">結果</label>
                <select id="record-result" class="record-input-control bg-white">
                  <option value="">請選擇</option>
                  <option value="win">止盈</option>
                  <option value="loss">止損</option>
                  <option value="exit">提前出場</option>
                  <option value="open">持倉中</option>
                </select>
              </div>
            </div>
          </div>
          <div class="record-section">
            <div class="record-section-title">金額資訊</div>
            <div>
              <label class="block text-sm mb-1 text-gray-600">盈虧（USDT）</label>
              <input id="record-pnl" class="record-input-control" placeholder="例如：+5 / -13">
            </div>
          </div>
          <div class="record-section">
            <div class="record-section-title">摘要</div>
            <textarea id="record-summary" rows="4" class="record-textarea" placeholder="概述策略與觀察"></textarea>
          </div>
          <div id="record-bottom" class="hidden"></div>
        </div>
        <div class="record-right-stack space-y-5">
          <div class="record-card-panel">
            <div class="record-section-title">標籤</div>
            <div id="record-tag-chips" class="flex flex-wrap gap-2 mt-3"></div>
          </div>
          <div class="record-card-panel">
            <div class="record-section-title">新增標籤</div>
            <div class="flex gap-2 mt-3">
              <input id="tag-edit-input" type="text" placeholder="輸入標籤名稱" class="flex-1 record-input-control bg-white" />
              <button id="tag-edit-add" type="button" class="bg-black text-white rounded-xl px-4 py-2 text-sm hover:bg-gray-800">新增</button>
            </div>
            <div id="tag-edit-list" class="flex flex-wrap gap-2 mt-4"></div>
          </div>
          <div class="record-card-panel">
            <div class="record-section-title">自訂欄位</div>
            <div id="record-extra-fields" class="space-y-3 mt-4"></div>
          </div>
        </div>
      </div>
      <div class="record-modal-actions">
        <button id="record-cancel" class="record-action-btn border border-gray-300 bg-white text-gray-600">取消</button>
        <button id="record-submit" class="record-action-btn bg-black text-white">建立</button>
      </div>
    </div>
  </div>

  <!-- Detail Drawer -->
  <div id="detail-bg" class="fixed inset-0 bg-black bg-opacity-30 hidden z-[70] flex items-start justify-end">
    <div id="detail-drawer" class="w-full max-w-md bg-white h-full shadow-2xl transform translate-x-full transition-transform duration-300 overflow-y-auto p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 id="detail-title" class="text-2xl font-bold">交易紀錄詳情</h2>
        <button id="detail-close" class="text-gray-500 hover:text-gray-800 text-2xl" aria-label="關閉詳情">×</button>
      </div>
      <div class="mb-6" id="detail-image-area">
        <img id="detail-image-preview" alt="紀錄截圖" class="w-full rounded-xl border border-gray-300 hidden" />
        <div id="detail-image-placeholder" class="text-center text-xs text-gray-400 border border-gray-300 rounded-xl py-12">
          尚無圖片
        </div>
        <input id="detail-image-input" type="file" class="hidden" accept="image/*" />
      </div>
      <div class="space-y-5">
        <div class="record-line">
          <label class="record-label">幣種</label>
          <input id="detail-symbol" class="record-input" disabled />
        </div>
        <div class="record-line">
          <label class="record-label">時間</label>
          <input id="detail-date" type="date" class="record-input" disabled />
        </div>
        <div class="record-line">
          <label class="record-label">方向</label>
          <select id="detail-side" class="record-input" disabled>
            <option value="long">做多</option>
            <option value="short">做空</option>
          </select>
        </div>
        <div class="record-line">
          <label class="record-label">結果</label>
          <select id="detail-result" class="record-input" disabled>
            <option value="win">止盈</option>
            <option value="loss">止損</option>
            <option value="exit">提前出場</option>
            <option value="open">持倉中</option>
          </select>
        </div>
        <div class="record-line">
          <label class="record-label">盈虧</label>
          <input id="detail-pnl" class="record-input" disabled />
        </div>
        <div class="record-line">
          <label class="record-label">摘要</label>
          <input id="detail-summary" class="record-input" disabled />
        </div>
        <div id="detail-extra-fields" class="space-y-4"></div>
      </div>
      <div class="mt-10 flex justify-between items-center gap-4">
        <button id="detail-edit" class="px-5 py-2 border border-gray-300 rounded-xl hover:bg-gray-100">編輯</button>
        <div class="flex gap-3">
          <button id="detail-delete" class="px-4 py-2 border border-red-300 text-red-600 rounded-xl hover:bg-red-50">刪除</button>
          <button id="detail-save" class="px-5 py-2 bg-black text-white rounded-xl hover:bg-gray-800 hidden">保存</button>
          <button id="detail-cancel" class="px-5 py-2 border border-gray-300 rounded-xl hover:bg-gray-100 hidden">取消</button>
        </div>
      </div>
      <div class="mt-10 text-xs text-gray-400" id="detail-id"></div>
    </div>
  </div>

  <div id="delete-dialog-bg" class="fixed inset-0 bg-black bg-opacity-40 hidden z-[80] flex items-center justify-center">
    <div id="delete-dialog" class="bg-white rounded-xl shadow-2xl p-6 w-80">
      <h3 class="text-lg font-semibold mb-4">確認刪除紀錄</h3>
      <p class="text-sm text-gray-600 mb-6">此操作無法復原。</p>
      <div class="flex justify-end gap-3">
        <button id="delete-cancel" class="px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-100">取消</button>
        <button id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700">刪除</button>
      </div>
    </div>
  </div>

  <div id="confirm-delete-box" style="display:none;">
    <button id="confirm-yes" aria-hidden="true">是</button>
    <button id="confirm-no" aria-hidden="true">否</button>
  </div>

  <script type="module" src="./assets/js/records.js"></script>
  <script type="module" src="./js/main.js"></script>
  <script>
  (function(){
    const poly = document.getElementById('asset-polyline');
    const todayPnl = document.getElementById('today-pnl');
    const buttons = document.querySelectorAll('.asset-btn');
    if (!poly || !todayPnl || !buttons.length) return;
    const ranges = {1:1,7:7,30:30,90:90};
    let currentRange = '1';
    let lastDay = new Date().toDateString();
    function buildFlatPoints(count){
      const h = 60;
      const step = 400 / Math.max(count-1,1);
      const pts = [];
      for(let i=0;i<count;i++) pts.push(`${(step*i).toFixed(1)},${h}`);
      return pts.join(' ');
    }
    function setRange(days){
      const d = ranges[days] || 30;
      poly.setAttribute('points', buildFlatPoints(d));
      todayPnl.textContent = '+0 USDT';
      buttons.forEach(btn => btn.classList.remove('active'));
      const active = document.querySelector(`.asset-btn[data-range='${days}']`);
      active?.classList.add('active');
      currentRange = String(days);
    }
    buttons.forEach(btn => {
      btn.addEventListener('click', () => setRange(btn.dataset.range));
    });
    function checkMidnight(){
      const today = new Date().toDateString();
      if (today !== lastDay){
        setRange(currentRange);
        lastDay = today;
      }
    }
    setInterval(checkMidnight, 60 * 1000);
    setRange(1);
  })();
  </script>
  <script type="module">
    import { apiGet, apiPost } from "./js/api.js";

    (function persistTokenFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      if (token) {
        localStorage.setItem("token", token);
        params.delete("token");
        const cleanUrl = `${window.location.pathname}${
          params.toString() ? "?" + params.toString() : ""
        }`;
        window.history.replaceState({}, "", cleanUrl);
      }
    })();

    const BACKEND_URL = "http://localhost:3000";
    const navEmail = document.getElementById('nav-email');
    const logoutBtn = document.getElementById('nav-logout');

    function performLogout() {
      localStorage.removeItem('token');
      localStorage.removeItem('authUser');
      window.location.href = 'login.html';
    }

    async function loadCurrentUser() {
      const token = localStorage.getItem('token');
      if (!token) {
        performLogout();
        return;
      }
      try {
        const data = await apiGet("/users/me");
        if (navEmail) navEmail.textContent = data.email || '--';
        const stored = JSON.parse(localStorage.getItem('authUser') || '{}');
        stored.username = stored.username || data.email?.split('@')[0] || 'user';
        stored.email = data.email;
        stored.uid = stored.uid || data.id;
        stored.googleId = data.google_id;
        localStorage.setItem('authUser', JSON.stringify(stored));
      } catch (err) {
        console.error(err);
        performLogout();
      }
    }

    logoutBtn?.addEventListener('click', performLogout);
    loadCurrentUser();
  </script>

  <div id="profile-modal" class="fixed inset-0 bg-black/30 hidden z-[90] flex items-center justify-center">
    <div class="bg-white w-full max-w-lg border border-gray-200 rounded-2xl shadow-2xl p-8 space-y-6">
      <div class="flex justify-between items-start">
        <div class="text-xl font-semibold">個人資料</div>
        <button id="profile-close" class="text-2xl text-gray-500 hover:text-gray-800" aria-label="關閉">×</button>
      </div>
      <div class="flex items-center gap-4">
        <div class="w-20 h-20 rounded-full overflow-hidden border border-gray-300 cursor-pointer" id="profile-avatar-box">
          <img id="profile-avatar" src="" class="w-full h-full object-cover" alt="使用者頭像" />
        </div>
        <div>
          <div class="font-medium text-lg" id="profile-nick"></div>
          <input id="profile-name-input" type="text" class="hidden mt-2 border border-gray-300 rounded-xl px-3 py-2 text-sm" />
          <div class="text-sm text-gray-500">UID：<span id="profile-uid">100001</span></div>
          <button id="profile-edit" class="mt-3 px-3 py-1 border border-gray-300 rounded-xl text-sm hover:bg-gray-100">編輯暱稱</button>
        </div>
      </div>
      <div class="space-y-3">
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-600">Telegram</span>
          <button id="profile-tg" class="px-3 py-1 text-sm border border-gray-300 rounded-xl hover:bg-gray-100">綁定</button>
          <span id="profile-tg-status" class="text-sm text-green-600 hidden">已綁定：<span id="profile-tg-account"></span></span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-600">Google</span>
          <button id="profile-google" class="px-3 py-1 text-sm border border-gray-300 rounded-xl hover:bg-gray-100">綁定</button>
          <span id="profile-google-status" class="text-sm text-green-600 hidden">已綁定：<span id="profile-google-account"></span></span>
        </div>
      </div>
      <div>
        <div class="text-sm text-gray-600 mb-2">已連接交易所</div>
        <div id="profile-exchanges" class="space-y-2 text-sm text-gray-700"></div>
      </div>
      <button id="profile-logout" class="mt-2 w-full py-2 border border-red-300 text-red-600 rounded-xl text-sm hover:bg-red-50">登出</button>
    </div>
  </div>
</body>
</html>
