<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‰∫§Ê?Ë©≥Á¥∞Á¥Ä??/title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-black">
  <div class="min-h-screen flex">

    <!-- Â∑¶ÂÅ¥?¥Ê?ÔºàË??∂‰??Å‰??¥Ô? -->
    <aside class="w-64 px-6 py-8 flex flex-col border-r border-gray-200">
      <div>
        <div class="w-28 h-28 border border-gray-300 rounded-full mx-auto mb-4"></div>
        <div class="text-center font-semibold tracking-wide mb-8">NAME</div>

        <div class="border border-gray-300 rounded-2xl px-4 py-3 mb-6">
          <div class="flex items-center justify-between py-1">
            <span class="text-sm">binance</span>
            <span class="w-3 h-3 rounded-full bg-green-500"></span>
          </div>
          <div class="flex items-center justify-between py-1 border-t border-gray-200">
            <span class="text-sm">bybit</span>
            <span class="w-3 h-3 rounded-full bg-green-500"></span>
          </div>
          <div class="flex items-center justify-between py-1 border-t border-gray-200">
            <span class="text-sm">bitget</span>
            <span class="w-3 h-3 rounded-full bg-red-500"></span>
          </div>

          <div class="text-center text-xs text-gray-400 mt-2 mb-1">......</div>

          <button
            class="mt-1 w-full border border-gray-300 rounded-xl text-sm py-1 hover:bg-gray-100 transition">
            +
          </button>
        </div>
      </div>

      <div class="mt-auto">
        <a href="add.html">
          <button
            class="w-full border border-gray-300 rounded-xl py-2 text-sm hover:bg-gray-100 transition">
            Âø´ÈÄüÂª∫Á´?
          </button>
        </a>
      </div>
    </aside>

    <!-- ‰∏ªÂÖßÂÆ?-->
    <main class="flex-1 px-10 py-8">

      <!-- Ê®ôÈ? + ËøîÂ? -->
      <header class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-xl font-semibold tracking-wide mb-1">‰∫§Ê?Ë©≥Á¥∞Á¥Ä??/h1>
          <p class="text-xs text-gray-500">Ê™¢Ë?‰∏¶Á∑®ËºØÈÄô‰?Á≠Ü‰∫§??/p>
        </div>

        <a href="records.html"
           class="text-xs text-gray-500 underline hover:text-gray-700">
          ??ËøîÂ?Á¥Ä?ÑÂ?Ë°?
        </a>
      </header>

      <!-- Ê¶ÇË??°Á? -->
      <section class="border border-gray-200 rounded-2xl px  -6 py-4 mb-8 flex justify-between items-center">
        <div>
          <div class="text-xs text-gray-500 mb-1">Âπ?®Æ / ?πÂ?</div>
          <div class="flex items-baseline gap-3">
            <span id="detail-meta-symbol" class="text-lg font-semibold">BTCUSDT</span>
            <span id="detail-meta-side" class="text-sm text-gray-600">Â§öÂñÆ ¬∑ 10x</span>
          </div>
          <div id="detail-meta-exchange" class="text-xs text-gray-400 mt-1">binance ¬∑ 2025/02/05 21:30</div>
        </div>

        <div class="text-right">
          <div class="text-xs text-gray-500 mb-1">?àËôßÔºàUSDTÔº?/div>
          <div id="detail-meta-pnl" class="text-xl font-semibold text-green-600">+45.2</div>
          <div id="detail-meta-pct" class="text-xs text-green-600 mt-1">+45.2%</div>
        </div>
      </section>

      <!-- Á∑®ËºØË°®ÂñÆÔºà‰?ÂæåÂèØ??JS ÂØ¶È??¥Êñ∞Ôº?-->
      <form class="max-w-xl">

        <!-- ?•Ê??ÇÈ? -->
        <div class="mb-5">
          <label class="block text-sm mb-1">?•Ê??ÇÈ?</label>
          <input id="detail-traded-at" type="datetime-local"
                 value="2025-02-05T21:30"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" />
        </div>

        <!-- ‰∫§Ê??Ä -->
        <div class="mb-5">
          <label class="block text-sm mb-1">‰∫§Ê??Ä</label>
          <select id="detail-exchange" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
            <option selected>binance</option>
            <option>bybit</option>
            <option>bitget</option>
          </select>
        </div>

        <!-- Âπ?®Æ -->
        <div class="mb-5">
          <label class="block text-sm mb-1">Âπ?®Æ</label>
          <input id="detail-symbol" type="text"
                 value="BTCUSDT"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" />
        </div>

        <!-- ?πÂ? + ÊßìÊ°ø -->
        <div class="mb-5 grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">?πÂ?</label>
            <select id="detail-side" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
              <option selected>Â§öÂñÆ</option>
              <option>Á©∫ÂñÆ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">ÊßìÊ°ø</label>
            <input id="detail-leverage" type="number"
                   value="10"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" />
          </div>
        </div>

        <!-- ‰øùË???+ ?àËôß USDT + ?àËôß??-->
        <div class="mb-5 grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-1">‰øùË??ëÔ?USDTÔº?/label>
            <input id="detail-margin" type="number"
                   value="100"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-sm mb-1">?àËôßÔºàUSDTÔº?/label>
            <input id="detail-pnl-usdt" type="number"
                   value="45.2"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm text-green-700" />
          </div>
          <div>
            <label class="block text-sm mb-1">?àËôß?áÔ?%Ôº?/label>
            <input id="detail-pnl-pct" type="number"
                   value="45.2"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm text-green-700" />
          </div>
        </div>

        <!-- Ê®ôÁ±§ -->
        <div class="mb-5">
          <label class="block text-sm mb-1">Ê®ôÁ±§</label>
          <input id="detail-summary" type="text"
                 placeholder="Â¶ÇÔ?Ë∂®Âã¢Âª∂Á? / ?ÖÁ?Â§±Êéß / Á≠ñÁï• A"
                 value="Ë∂®Âã¢Âª∂Á?"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" />
        </div>

        <!-- ?ôË®ª -->
        <div class="mb-5">
          <label class="block text-sm mb-1">?ôË®ª</label>
          <textarea id="detail-notes"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm h-24">Á™ÅÁ†¥ÂæåÂ?Ë∏©ÈÄ≤Â†¥ÔºåÊ?Ë®àÁï´Ê≠¢Á???/textarea>
        </div>

        <!-- ?™Â? -->
        <div class="mb-8">
          <label class="block text-sm mb-1">?™Â?ÔºàÂèØ?çÊñ∞‰∏äÂÇ≥Ôº?/label>
          <input id="detail-image" type="file" class="text-sm" />
          <div id="detail-meta-exchange" class="text-xs text-gray-400 mt-1">?ÆÂ?Â∑≤‰??≥Ô?chart_btc_20250205.pngÔºàÁ§∫?èÔ?</div>
        </div>

        <!-- ?âÈ??Ä -->
        <div class="flex justify-between items-center gap-4">
          <button type="button"
                  class="text-xs text-gray-500 underline hover:text-gray-700">
            ??ËøîÂ??óË°®
          </button>

          <div class="flex gap-3">
            <button type="button"
                    id="detail-delete" class="px-4 py-2 border border-gray-300 rounded-xl text-xs text-red-600 hover:bg-gray-100 transition">
              ?™Èô§Á¥Ä??
            </button>
            <button id="detail-save" type="button"
                    class="px-6 py-2 bg-black text-white rounded-xl text-sm hover:bg-gray-800 transition">
              ?≤Â?‰øÆÊîπ
            </button>
          </div>
        </div>

      </form>

    </main>
  </div>
<script type="module">
  import { fetchRecordById, updateRecord, deleteRecord } from "./js/api.js";

  const params = new URLSearchParams(window.location.search);
  const recordId = Number(params.get("id"));
  let currentRecord = null;

  const pad = num => String(num).padStart(2, "0");
  const toNumberOrNull = value => {
    if (value === undefined || value === null || value === "") return null;
    const num = Number(value);
    return isNaN(num) ? null : num;
  };
  const getEl = id => document.getElementById(id);

  function formatDateTime(value) {
    if (!value) return "--";
    const date = new Date(value);
    if (isNaN(date.getTime())) return value;
    return `${date.getFullYear()}/${pad(date.getMonth() + 1)}/${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function formatChange(value, suffix = "USDT") {
    if (value === null || value === undefined || value === "") return `0 ${suffix}`;
    const num = Number(value);
    if (isNaN(num)) return `${value} ${suffix}`;
    const sign = num > 0 ? "+" : "";
    return `${sign}${num} ${suffix}`;
  }

  function toDatetimeLocal(value) {
    if (!value) return "";
    const date = new Date(value);
    if (isNaN(date.getTime())) return value;
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function fillRecordUI(record) {
    getEl("detail-traded-at").value = toDatetimeLocal(record.traded_at);
    getEl("detail-exchange").value = record.extra_fields?.exchange || "";
    getEl("detail-symbol").value = record.symbol || "";
    getEl("detail-side").value = record.side || "";
    getEl("detail-leverage").value = record.leverage ?? "";
    getEl("detail-margin").value = record.margin_usdt ?? "";
    getEl("detail-pnl-usdt").value = record.pnl_usdt ?? "";
    getEl("detail-pnl-pct").value = record.pnl_pct ?? "";
    getEl("detail-summary").value = record.summary || "";
    getEl("detail-notes").value = record.extra_fields?.notes || "";

    getEl("detail-meta-symbol").textContent = record.symbol || "-";
    getEl("detail-meta-side").textContent = `${record.side || "-"} °P ${record.leverage ? record.leverage + "x" : "-"}`;
    getEl("detail-meta-exchange").textContent = `${record.extra_fields?.exchange || "-"} °P ${formatDateTime(record.traded_at)}`;

    const pnlEl = getEl("detail-meta-pnl");
    const pctEl = getEl("detail-meta-pct");
    const pnlValue = Number(record.pnl_usdt) || 0;
    pnlEl.textContent = formatChange(record.pnl_usdt);
    pnlEl.classList.toggle("text-green-600", pnlValue >= 0);
    pnlEl.classList.toggle("text-red-600", pnlValue < 0);

    const pctValue = Number(record.pnl_pct) || 0;
    pctEl.textContent = formatChange(record.pnl_pct, "%");
    pctEl.classList.toggle("text-green-600", pctValue >= 0);
    pctEl.classList.toggle("text-red-600", pctValue < 0);
  }

  function collectPayload() {
    const extra = {};
    const exchange = getEl("detail-exchange").value.trim();
    if (exchange) extra.exchange = exchange;
    const notes = getEl("detail-notes").value.trim();
    if (notes) extra.notes = notes;
    return {
      symbol: getEl("detail-symbol").value.trim(),
      side: getEl("detail-side").value,
      leverage: toNumberOrNull(getEl("detail-leverage").value),
      margin_usdt: toNumberOrNull(getEl("detail-margin").value),
      pnl_usdt: toNumberOrNull(getEl("detail-pnl-usdt").value),
      pnl_pct: toNumberOrNull(getEl("detail-pnl-pct").value),
      summary: getEl("detail-summary").value.trim(),
      traded_at: getEl("detail-traded-at").value ? new Date(getEl("detail-traded-at").value).toISOString() : null,
      image_url: currentRecord?.image_url || null,
      tags: currentRecord?.tags || [],
      extra_fields: Object.keys(extra).length ? extra : currentRecord?.extra_fields || null
    };
  }

  async function loadRecord() {
    if (!recordId) {
      alert("Ø §÷¨ˆø˝ ID");
      return;
    }
    try {
      const record = await fetchRecordById(recordId);
      if (!record) throw new Error("Not found");
      currentRecord = record;
      fillRecordUI(record);
    } catch (err) {
      console.error(err);
      alert("µL™k∏¸§J¨ˆø˝");
    }
  }

  getEl("detail-save")?.addEventListener("click", async () => {
    try {
      const payload = collectPayload();
      const updated = await updateRecord(recordId, payload);
      currentRecord = updated;
      fillRecordUI(updated);
      alert("§wßÛ∑s");
    } catch (err) {
      console.error(err);
      alert("ßÛ∑s•¢±—°AΩ–µy´·¶A∏’");
    }
  });

  getEl("detail-delete")?.addEventListener("click", async () => {
    if (!recordId) return;
    if (!confirm("ΩTª{ßR∞£¶π¨ˆø˝°H")) return;
    try {
      await deleteRecord(recordId);
      alert("§wßR∞£");
      window.location.href = "records.html";
    } catch (err) {
      console.error(err);
      alert("ßR∞£•¢±—°AΩ–µy´·¶A∏’");
    }
  });

  loadRecord();
</script>
</body>
</html>













